<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlipHawk | Smart Arbitrage Scanner</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #FF6B6B;
            --secondary-color: #4ECDC4;
            --accent-color: #FFE66D;
            --dark-bg: #1A1A2E;
            --card-bg: #16213E;
            --text-color: #E0E0E0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--dark-bg);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        header {
            padding: 20px 0;
            background: linear-gradient(135deg, var(--card-bg) 0%, var(--dark-bg) 100%);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .logo {
            font-size: 2em;
            font-weight: 800;
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .auth-buttons {
            display: flex;
            gap: 10px;
        }

        .auth-button {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-color);
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .auth-button:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .user-menu {
            position: relative;
            display: none;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            cursor: pointer;
        }

        .user-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 10px;
            background: var(--card-bg);
            border-radius: 10px;
            width: 200px;
            z-index: 100;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            display: none;
        }

        .user-dropdown.active {
            display: block;
        }

        .dropdown-item {
            padding: 12px 16px;
            display: block;
            color: var(--text-color);
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .dropdown-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .dropdown-divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
        }

        .hero {
            text-align: center;
            padding: 80px 20px;
            background: linear-gradient(135deg, rgba(255,107,107,0.1) 0%, rgba(78,205,196,0.1) 100%);
            border-radius: 20px;
            margin: 40px 0;
        }

        .hero h1 {
            font-size: 3.5em;
            margin-bottom: 20px;
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 40px 0;
        }

        .category-card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .category-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            border-color: var(--secondary-color);
        }

        .category-card.active {
            border-color: var(--primary-color);
            box-shadow: 0 0 20px rgba(255, 107, 107, 0.3);
        }

        .category-icon {
            font-size: 2.5em;
            margin-bottom: 15px;
            color: var(--secondary-color);
        }

        .subcategory-container {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .subcategory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .subcategory-chip {
            background: rgba(78, 205, 196, 0.1);
            border: 1px solid var(--secondary-color);
            border-radius: 25px;
            padding: 10px 15px;
            font-size: 0.9em;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s ease;
        }

        .subcategory-chip:hover {
            background: rgba(78, 205, 196, 0.2);
            transform: translateY(-2px);
        }

        .subcategory-chip.selected {
            background: var(--secondary-color);
            color: var(--dark-bg);
            font-weight: 600;
        }

        .search-button {
            background: linear-gradient(to right, #666, #777);
            color: #999;
            border: none;
            padding: 15px 40px;
            font-size: 1.2em;
            border-radius: 30px;
            cursor: not-allowed;
            margin-top: 30px;
            transition: all 0.3s ease;
            display: inline-block;
        }

        .search-button.active {
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            color: white;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
        }

        .search-button.active:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(255, 107, 107, 0.4);
        }

        #results-container {
            margin-top: 40px;
        }

        .result-card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .result-image {
            width: 200px;
            height: 200px;
            object-fit: cover;
            border-radius: 10px;
        }

        .result-details {
            flex: 1;
        }

        .profit-badge {
            background: var(--primary-color);
            color: white;
            padding: 5px 15px;
            border-radius: 15px;
            font-weight: bold;
            display: inline-block;
            margin-bottom: 10px;
        }

        .spinner {
            display: none;
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 107, 107, 0.3);
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .selected-count {
            margin-top: 10px;
            font-size: 0.9em;
            color: var(--accent-color);
        }

        .progress-container {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            margin: 1rem 0;
            display: none;
        }
        
        .progress-bar {
            width: 0%;
            height: 100%;
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .scan-status {
            text-align: center;
            margin-top: 10px;
            display: none;
        }

        /* Modal styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 30px;
            width: 400px;
            max-width: 90%;
            position: relative;
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 1.5em;
            cursor: pointer;
        }

        .modal-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.8em;
            margin-bottom: 10px;
            color: var(--accent-color);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: var(--text-color);
            font-size: 1em;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--secondary-color);
        }

        .form-button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
        }

        .form-footer {
            text-align: center;
            margin-top: 20px;
        }

        .form-link {
            color: var(--secondary-color);
            cursor: pointer;
        }

        .error-message {
            background: rgba(255, 107, 107, 0.2);
            border-left: 3px solid var(--primary-color);
            color: var(--primary-color);
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 0 8px 8px 0;
            display: none;
        }

        .success-message {
            background: rgba(78, 205, 196, 0.2);
            border-left: 3px solid var(--secondary-color);
            color: var(--secondary-color);
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 0 8px 8px 0;
            display: none;
        }

        /* Toast notification */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--card-bg);
            color: var(--text-color);
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            z-index: 9999;
            animation: fadeIn 0.3s;
            max-width: 300px;
        }

        .toast.error {
            border-left: 4px solid var(--primary-color);
        }

        .toast.success {
            border-left: 4px solid var(--secondary-color);
        }

        @media (max-width: 768px) {
            .result-card {
                flex-direction: column;
            }
            
            .result-image {
                width: 100%;
                height: auto;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="logo">FlipHawk</div>
            <div class="auth-buttons" id="auth-buttons">
                <button class="auth-button" id="login-button">Login</button>
                <button class="auth-button" id="signup-button">Sign Up</button>
            </div>
            <div class="user-menu" id="user-menu">
                <div class="user-avatar" id="user-avatar">U</div>
                <div class="user-dropdown" id="user-dropdown">
                    <a href="#" class="dropdown-item">Dashboard</a>
                    <a href="#" class="dropdown-item">Saved Opportunities</a>
                    <a href="#" class="dropdown-item">Settings</a>
                    <div class="dropdown-divider"></div>
                    <a href="#" class="dropdown-item" id="logout-button">Logout</a>
                </div>
            </div>
        </div>
    </header>

    <main class="container">
        <section class="hero">
            <h1>Find Profitable Flips Instantly</h1>
            <p>Select a category to discover arbitrage opportunities across multiple marketplaces</p>
        </section>

        <div class="category-grid">
            <div class="category-card" data-category="Tech">
                <div class="category-icon">üíª</div>
                <h3>Tech</h3>
                <p>Electronics & Gadgets</p>
            </div>
            <div class="category-card" data-category="Collectibles">
                <div class="category-icon">üé¥</div>
                <h3>Collectibles</h3>
                <p>Cards & Memorabilia</p>
            </div>
            <div class="category-card" data-category="Vintage Clothing">
                <div class="category-icon">üëü</div>
                <h3>Vintage Clothing</h3>
                <p>Fashion & Sneakers</p>
            </div>
            <div class="category-card" data-category="Antiques">
                <div class="category-icon">üï∞Ô∏è</div>
                <h3>Antiques</h3>
                <p>Rare & Vintage Items</p>
            </div>
            <div class="category-card" data-category="Gaming">
                <div class="category-icon">üéÆ</div>
                <h3>Gaming</h3>
                <p>Consoles & Games</p>
            </div>
            <div class="category-card" data-category="Music Gear">
                <div class="category-icon">üé∏</div>
                <h3>Music Gear</h3>
                <p>Instruments & Audio</p>
            </div>
            <div class="category-card" data-category="Tools & DIY">
                <div class="category-icon">üõ†Ô∏è</div>
                <h3>Tools & DIY</h3>
                <p>Power & Hand Tools</p>
            </div>
            <div class="category-card" data-category="Outdoors & Sports">
                <div class="category-icon">üö≤</div>
                <h3>Outdoors & Sports</h3>
                <p>Gear & Equipment</p>
            </div>
        </div>

        <div class="subcategory-container" id="subcategory-panel">
            <h3>Select Subcategories</h3>
            <p>Choose up to 5 subcategories to narrow your search</p>
            <div class="subcategory-grid" id="subcategory-grid">
                <!-- Subcategories will be dynamically inserted here -->
            </div>
            <div class="selected-count" id="selected-count">0 of 5 subcategories selected</div>
        </div>

        <div style="text-align: center;">
            <button class="search-button" id="search-button" disabled>Begin Resale Search</button>
        </div>

        <div id="results-container">
            <div class="spinner" id="loading-spinner"></div>
            <div class="progress-container" id="progress-container">
                <div class="progress-bar" id="progress-bar"></div>
            </div>
            <div class="scan-status" id="scan-status">Preparing scan...</div>
            <!-- Results will be dynamically inserted here -->
        </div>
    </main>

    <!-- Login Modal -->
    <div class="modal" id="login-modal">
        <div class="modal-content">
            <button class="close-modal" id="close-login">&times;</button>
            <div class="modal-header">
                <h2 class="modal-title">Login to FlipHawk</h2>
                <p>Access your account to save opportunities</p>
            </div>
            <div class="error-message" id="login-error"></div>
            <div class="success-message" id="login-success"></div>
            <form id="login-form">
                <div class="form-group">
                    <label class="form-label" for="login-email">Email</label>
                    <input type="email" class="form-input" id="login-email" placeholder="Enter your email" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="login-password">Password</label>
                    <input type="password" class="form-input" id="login-password" placeholder="Enter your password" required>
                </div>
                <button type="submit" class="form-button">Login</button>
            </form>
            <div class="form-footer">
                <p>Don't have an account? <span class="form-link" id="switch-to-signup">Sign up</span></p>
            </div>
        </div>
    </div>

    <!-- Signup Modal -->
    <div class="modal" id="signup-modal">
        <div class="modal-content">
            <button class="close-modal" id="close-signup">&times;</button>
            <div class="modal-header">
                <h2 class="modal-title">Create an Account</h2>
                <p>Join FlipHawk to track your opportunities</p>
            </div>
            <div class="error-message" id="signup-error"></div>
            <div class="success-message" id="signup-success"></div>
            <form id="signup-form">
                <div class="form-group">
                    <label class="form-label" for="signup-username">Username</label>
                    <input type="text" class="form-input" id="signup-username" placeholder="Choose a username" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="signup-email">Email</label>
                    <input type="email" class="form-input" id="signup-email" placeholder="Enter your email" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="signup-password">Password</label>
                    <input type="password" class="form-input" id="signup-password" placeholder="Choose a password (min. 6 characters)" required>
                </div>
                <button type="submit" class="form-button">Create Account</button>
            </form>
            <div class="form-footer">
                <p>Already have an account? <span class="form-link" id="switch-to-login">Login</span></p>
            </div>
        </div>
    </div>

    <script>
        // Categories and subcategories data
        const categories = {
            "Tech": ["Headphones", "Keyboards", "Graphics Cards", "CPUs", "Laptops", "Monitors", "SSDs", "Routers", "Vintage Tech"],
            "Collectibles": ["Pok√©mon", "Magic: The Gathering", "Yu-Gi-Oh", "Funko Pops", "Sports Cards", "Comic Books", "Action Figures", "LEGO Sets"],
            "Vintage Clothing": ["Jordans", "Nike Dunks", "Vintage Tees", "Band Tees", "Denim Jackets", "Designer Brands", "Carhartt", "Patagonia"],
            "Antiques": ["Coins", "Watches", "Cameras", "Typewriters", "Vinyl Records", "Vintage Tools", "Old Maps", "Antique Toys"],
            "Gaming": ["Consoles", "Game Controllers", "Rare Games", "Arcade Machines", "Handhelds", "Gaming Headsets", "VR Gear"],
            "Music Gear": ["Electric Guitars", "Guitar Pedals", "Synthesizers", "Vintage Amps", "Microphones", "DJ Equipment"],
            "Tools & DIY": ["Power Tools", "Hand Tools", "Welding Equipment", "Toolboxes", "Measuring Devices", "Woodworking Tools"],
            "Outdoors & Sports": ["Bikes", "Skateboards", "Scooters", "Camping Gear", "Hiking Gear", "Fishing Gear", "Snowboards"]
        };

        // Global variables
        let selectedCategory = '';
        let selectedSubcategories = [];
        let currentUser = null;

        // DOM Elements
        const authButtons = document.getElementById('auth-buttons');
        const userMenu = document.getElementById('user-menu');
        const userAvatar = document.getElementById('user-avatar');
        const userDropdown = document.getElementById('user-dropdown');
        const loginButton = document.getElementById('login-button');
        const signupButton = document.getElementById('signup-button');
        const logoutButton = document.getElementById('logout-button');
        const loginModal = document.getElementById('login-modal');
        const signupModal = document.getElementById('signup-modal');
        const closeLogin = document.getElementById('close-login');
        const closeSignup = document.getElementById('close-signup');
        const switchToSignup = document.getElementById('switch-to-signup');
        const switchToLogin = document.getElementById('switch-to-login');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const loginError = document.getElementById('login-error');
        const signupError = document.getElementById('signup-error');
        const loginSuccess = document.getElementById('login-success');
        const signupSuccess = document.getElementById('signup-success');
        const subcategoryPanel = document.getElementById('subcategory-panel');
        const subcategoryGrid = document.getElementById('subcategory-grid');
        const selectedCount = document.getElementById('selected-count');
        const searchButton = document.getElementById('search-button');
        const loadingSpinner = document.getElementById('loading-spinner');
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        const scanStatus = document.getElementById('scan-status');
        const resultsContainer = document.getElementById('results-container');

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            checkAuth();
        });

        // Set up event listeners
        function setupEventListeners() {
            // Category selection
            document.querySelectorAll('.category-card').forEach(card => {
                card.addEventListener('click', function() {
                    document.querySelectorAll('.category-card').forEach(c => c.classList.remove('active'));
                    this.classList.add('active');
                    selectedCategory = this.dataset.category;
                    showSubcategories(selectedCategory);
                });
            });

            // Search button
            searchButton.addEventListener('click', function() {
                if (currentUser) {
                    startScan();
                } else {
                    loginModal.classList.add('active');
                }
            });

            // Auth buttons
            loginButton.addEventListener('click', function() {
                loginModal.classList.add('active');
            });

            signupButton.addEventListener('click', function() {
                signupModal.classList.add('active');
            });

            // Modal close buttons
            closeLogin.addEventListener('click', function() {
                loginModal.classList.remove('active');
            });

            closeSignup.addEventListener('click', function() {
                signupModal.classList.remove('active');
            });

            // Switch between login and signup
            switchToSignup.addEventListener('click', function() {
                loginModal.classList.remove('active');
                signupModal.classList.add('active');
            });

            switchToLogin.addEventListener('click', function() {
                signupModal.classList.remove('active');
                loginModal.classList.add('active');
            });

            // Form submissions
            loginForm.addEventListener('submit', function(e) {
                e.preventDefault();
                handleLogin();
            });

            signupForm.addEventListener('submit', function(e) {
                e.preventDefault();
                handleSignup();
            });

            // User menu toggle
            userAvatar.addEventListener('click', function() {
                userDropdown.classList.toggle('active');
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!userAvatar.contains(e.target) && !userDropdown.contains(e.target)) {
                    userDropdown.classList.remove('active');
                }
            });

            // Logout
            logoutButton.addEventListener('click', function(e) {
                e.preventDefault();
                handleLogout();
            });
        }

        // Check if user is logged in
        function checkAuth() {
            const token = localStorage.getItem('token');
            const userData = localStorage.getItem('user');
            
            if (token && userData) {
                try {
                    currentUser = JSON.parse(userData);
                    updateUIForLoggedInUser();
                } catch (e) {
                    console.error('Error parsing user data:', e);
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                }
            }
        }

        // Update UI for logged in user
        function updateUIForLoggedInUser() {
            if (currentUser) {
                // Show user menu, hide auth buttons
                authButtons.style.display = 'none';
                userMenu.style.display = 'block';
                
                // Set avatar text to first letter of username
                if (currentUser.username) {
                    userAvatar.textContent = currentUser.username.charAt(0).toUpperCase();
                }
            } else {
                // Show auth buttons, hide user menu
                authButtons.style.display = 'flex';
                userMenu.style.display = 'none';
            }
        }

        // Show subcategories for selected category
        function showSubcategories(category) {
            const subcats = categories[category];
            if (!subcats) return;
            
            subcategoryGrid.innerHTML = '';
            subcats.forEach(subcategory => {
                const chip = document.createElement('div');
                chip.className = 'subcategory-chip';
                chip.textContent = subcategory;
                chip.addEventListener('click', () => toggleSubcategory(chip, subcategory));
                subcategoryGrid.appendChild(chip);
            });
            
            subcategoryPanel.style.display = 'block';
            selectedSubcategories = [];
            updateSelectedCount();
            updateSearchButton();

            // Scroll to subcategories
            subcategoryPanel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // Toggle subcategory selection
        function toggleSubcategory(chip, subcategory) {
            if (chip.classList.contains('selected')) {
                chip.classList.remove('selected');
                selectedSubcategories = selectedSubcategories.filter(s => s !== subcategory);
            } else if (selectedSubcategories.length < 5) {
                chip.classList.add('selected');
                selectedSubcategories.push(subcategory);
            } else {
                showToast('You can only select up to 5 subcategories', 'error');
            }
            updateSelectedCount();
            updateSearchButton();
        }

        // Update selected count
        function updateSelectedCount() {
            selectedCount.textContent = `${selectedSubcategories.length} of 5 subcategories selected`;
            
            // Change color when approaching limit
            if (selectedSubcategories.length >= 5) {
                selectedCount.style.color = 'var(--primary-color)';
                selectedCount.style.fontWeight = 'bold';
            } else if (selectedSubcategories.length >= 3) {
                selectedCount.style.color = 'var(--accent-color)';
                selectedCount.style.fontWeight = 'normal';
            } else {
                selectedCount.style.color = 'var(--text-color)';
                selectedCount.style.fontWeight = 'normal';
            }
        }

        // Update search button state
        function updateSearchButton() {
            if (selectedSubcategories.length > 0) {
                searchButton.classList.add('active');
                searchButton.disabled = false;
            } else {
                searchButton.classList.remove('active');
                searchButton.disabled = true;
            }
        }

        // Handle login
        async function handleLogin() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            // Hide previous messages
            loginError.style.display = 'none';
            loginSuccess.style.display = 'none';
            
            // Disable submit button
            const submitButton = loginForm.querySelector('.form-button');
            submitButton.disabled = true;
            submitButton.textContent = 'Logging in...';
            
            try {
                const response = await fetch('/api/v1/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Save token and user data
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('user', JSON.stringify({
                        email: data.email,
                        username: data.username
                    }));
                    
                    // Set current user
                    currentUser = {
                        email: data.email,
                        username: data.username
                    };
                    
                    // Show success message
                    loginSuccess.textContent = 'Login successful!';
                    loginSuccess.style.display = 'block';
                    
                    // Update UI
                    updateUIForLoggedInUser();
                    
                    // Close modal after delay
                    setTimeout(function() {
                        loginModal.classList.remove('active');
                    }, 1000);
                } else {
                    // Show error message
                    loginError.textContent = data.message || 'Login failed. Please check your credentials.';
                    loginError.style.display = 'block';
                    
                    // Reset button
                    submitButton.disabled = false;
                    submitButton.textContent = 'Login';
                }
            } catch (error) {
                console.error('Login error:', error);
                loginError.textContent = 'A network error occurred. Please try again.';
                loginError.style.display = 'block';
                
                // Reset button
                submitButton.disabled = false;
                submitButton.textContent = 'Login';
            }
        }

        // Handle signup
        async function handleSignup() {
            const username = document.getElementById('signup-username').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            
            // Hide previous messages
            signupError.style.display = 'none';
            signupSuccess.style.display = 'none';
            
            // Validate inputs
            if (password.length < 6) {
                signupError.textContent = 'Password must be at least 6 characters long.';
                signupError.style.display = 'block';
                return;
            }
            
            if (username.length < 3) {
                signupError.textContent = 'Username must be at least 3 characters long.';
                signupError.style.display = 'block';
                return;
            }
            
            // Disable submit button
            const submitButton = signupForm.querySelector('.form-button');
            submitButton.disabled = true;
            submitButton.textContent = 'Creating account...';
            
            try {
                const response = await fetch('/api/v1/auth/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, email, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Show success message
                    signupSuccess.textContent = 'Account created successfully! You can now log in.';
                    signupSuccess.style.display = 'block';
                    
                    // Switch to login after delay
                    setTimeout(function() {
                        signupModal.classList.remove('active');
                        loginModal.classList.add('active');
                        
                        // Pre-fill email for convenience
                        document.getElementById('login-email').value = email;
                    }, 2000);
                } else {
                    // Show error message
                    signupError.textContent = data.message || 'Registration failed. Please try again.';
                    signupError.style.display = 'block';
                    
                    // Reset button
                    submitButton.disabled = false;
                    submitButton.textContent = 'Create Account';
                }
            } catch (error) {
                console.error('Signup error:', error);
                signupError.textContent = 'A network error occurred. Please try again.';
                signupError.style.display = 'block';
                
                // Reset button
                submitButton.disabled = false;
                submitButton.textContent = 'Create Account';
            }
        }

        // Handle logout
        function handleLogout() {
            // Clear stored data
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            
            // Reset current user
            currentUser = null;
            
            // Update UI
            updateUIForLoggedInUser();
            
            // Close dropdown
            userDropdown.classList.remove('active');
            
            // Show success toast
            showToast('You have been logged out successfully', 'success');
        }

        // Start scan function
        function startScan() {
            // Ensure user is logged in
            if (!currentUser) {
                loginModal.classList.add('active');
                return;
            }
            
            // Check if category and subcategories are selected
            if (!selectedCategory || selectedSubcategories.length === 0) {
                showToast('Please select a category and at least one subcategory', 'error');
                return;
            }
            
            // Clear previous results and show loading indicators
            resultsContainer.innerHTML = '';
            resultsContainer.appendChild(loadingSpinner);
            resultsContainer.appendChild(progressContainer);
            resultsContainer.appendChild(scanStatus);
            
            loadingSpinner.style.display = 'block';
            progressContainer.style.display = 'block';
            scanStatus.style.display = 'block';
            scanStatus.textContent = 'Preparing to scan...';
            progressBar.style.width = '0%';
            
            // Disable search button
            searchButton.disabled = true;
            searchButton.classList.remove('active');
            searchButton.textContent = 'Scanning...';
            
            // Get token
            const token = localStorage.getItem('token');
            if (!token) {
                showToast('Authentication error. Please log in again.', 'error');
                handleLogout();
                return;
            }
            
            // Simulate progress while scanning
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 5;
                if (progress < 95) {
                    progressBar.style.width = `${progress}%`;
                    
                    // Update scan status message
                    if (progress < 30) {
                        scanStatus.textContent = `Scanning marketplaces for ${selectedSubcategories.join(', ')}...`;
                    } else if (progress < 60) {
                        scanStatus.textContent = 'Finding matching products across platforms...';
                    } else {
                        scanStatus.textContent = 'Calculating potential profits...';
                    }
                }
            }, 300);
            
            // Make API request
            fetch('/api/v1/scan', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    category: selectedCategory,
                    subcategories: selectedSubcategories
                })
            })
            .then(response => {
                clearInterval(progressInterval);
                
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.message || 'Scan failed. Please try again.');
                    });
                }
                
                return response.json();
            })
            .then(results => {
                // Complete progress bar
                progressBar.style.width = '100%';
                
                // Show results after a short delay
                setTimeout(() => {
                    displayResults(results);
                    
                    // Reset search button
                    searchButton.disabled = false;
                    searchButton.classList.add('active');
                    searchButton.textContent = 'Begin Resale Search';
                    
                    // Hide loading state
                    loadingSpinner.style.display = 'none';
                    progressContainer.style.display = 'none';
                    scanStatus.style.display = 'none';
                }, 500);
            })
            .catch(error => {
                console.error('Scan error:', error);
                
                // Reset search button
                searchButton.disabled = false;
                searchButton.classList.add('active');
                searchButton.textContent = 'Begin Resale Search';
                
                // Hide loading state
                loadingSpinner.style.display = 'none';
                progressContainer.style.display = 'none';
                
                // Show error message
                scanStatus.textContent = error.message || 'An error occurred during the scan.';
                scanStatus.style.color = 'var(--primary-color)';
                scanStatus.style.display = 'block';
                
                setTimeout(() => {
                    scanStatus.style.display = 'none';
                    scanStatus.style.color = 'var(--text-color)';
                }, 5000);
            });
        }

        // Display scan results
        function displayResults(results) {
            // Clear previous results
            resultsContainer.innerHTML = '';
            
            if (!results || results.length === 0) {
                const noResults = document.createElement('div');
                noResults.style.textAlign = 'center';
                noResults.style.padding = '40px 20px';
                noResults.style.background = 'var(--card-bg)';
                noResults.style.borderRadius = '15px';
                noResults.style.marginTop = '30px';
                
                noResults.innerHTML = `
                    <div style="font-size: 3em; margin-bottom: 20px;">üò¢</div>
                    <h3>No Opportunities Found</h3>
                    <p>Try selecting different subcategories or come back later for new listings.</p>
                `;
                
                resultsContainer.appendChild(noResults);
                return;
            }
            
            // Create results header
            const resultsHeader = document.createElement('div');
            resultsHeader.style.background = 'var(--card-bg)';
            resultsHeader.style.padding = '20px';
            resultsHeader.style.borderRadius = '15px';
            resultsHeader.style.marginBottom = '20px';
            resultsHeader.innerHTML = `
                <h2>Found ${results.length} Opportunities</h2>
                <p>Category: ${selectedCategory} ‚Ä¢ Subcategories: ${selectedSubcategories.join(', ')}</p>
            `;
            
            resultsContainer.appendChild(resultsHeader);
            
            // Create result cards
            results.forEach(result => {
                const resultCard = document.createElement('div');
                resultCard.className = 'result-card';
                
                // Create image element if available
                let imageHtml = '';
                if (result.image_url) {
                    imageHtml = `<img src="${result.image_url}" alt="${result.title}" class="result-image">`;
                }
                
                resultCard.innerHTML = `
                    ${imageHtml}
                    <div class="result-details">
                        <div class="profit-badge">${result.profit.toFixed(2)} profit</div>
                        <h3>${result.title}</h3>
                        <p>Buy for: ${result.buyPrice.toFixed(2)} | Sell for: ${result.sellPrice.toFixed(2)}</p>
                        <p>ROI: ${result.profitPercentage.toFixed(1)}%</p>
                        <p>Category: ${selectedCategory} > ${result.subcategory || selectedSubcategories[0]}</p>
                        <div style="margin-top: 15px; display: flex; gap: 10px;">
                            <a href="${result.buyLink}" target="_blank" style="
                                background: var(--primary-color);
                                color: white;
                                padding: 8px 15px;
                                border-radius: 8px;
                                text-decoration: none;
                                font-weight: 600;
                            ">Buy Now</a>
                            <a href="${result.sellLink}" target="_blank" style="
                                background: var(--secondary-color);
                                color: white;
                                padding: 8px 15px;
                                border-radius: 8px;
                                text-decoration: none;
                                font-weight: 600;
                            ">View Listing</a>
                        </div>
                    </div>
                `;
                
                resultsContainer.appendChild(resultCard);
            });
        }

        // Show toast notification
        function showToast(message, type = 'error') {
            // Remove existing toasts
            document.querySelectorAll('.toast').forEach(toast => {
                document.body.removeChild(toast);
            });
            
            // Create toast
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            // Add to document
            document.body.appendChild(toast);
            
            // Remove after delay
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 0.5s ease';
                
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 500);
            }, 3000);
        }
    </script>
</body>
</html>
